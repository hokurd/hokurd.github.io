<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="北陸地区の道路をまとめたページです。">
  <meta name="robots" content="index, follow">

  <meta property="og:title" content="ほくりく道路図鑑">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ほくりく道路図鑑">
  <meta property="og:locale" content="ja_JP">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ほくりく道路図鑑">
  <meta name="twitter:description" content="北陸地区の道路をまとめたページです。">

  <title>ほくりく道路図鑑 | 現在地から探す</title>
  <link rel="stylesheet" href="https://hokurd.github.io/assets/css/common.css">
  <link rel="icon" href="https://hokurd.github.io/assets/img/rd/country/41.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1><a href="https://hokurd.github.io/" style="color: white;"><img src="https://hokurd.github.io/assets/img/rd/country/41.png" alt="管理団体画像" style="height:48px; width:auto;"> ほくりく道路図鑑</a></h1>
  </header>

  <div class="container">
    <aside id="menu"></aside>

    <main id="content">
      <section>
        <h2>現在地から探す</h2>
        <p>現在地から探します。</p>
      </section>
      <div class="spacer"></div>
      <section>
      <h2>現在地</h2>
        <div id="map" style="width:100%; height:400px;"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>今走行している道路</h2>
        <div id="current-road"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>次の交差点</h2>
        <div id="next-intersection"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>最も近い国道</h2>
        <div id="nearest-trunk"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>最も近い県道</h2>
        <div id="nearest-pref"></div>
      </section>
    </main>
  </div>

  <footer>
    <p>Copyright © いゆかも工房 All rights reserved.</p>
  </footer>

  <script>
    function escapeHtml(s){ return String(s || '').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function makeRoadLink(tags){
      if(!tags) return '不明な道路';
      const ref = tags.ref || '';
      const name = tags.name || '';
      const highway = tags.highway || '';

      if((highway === 'trunk' || highway === 'primary') && /^\d+$/.test(ref)){
        const num = ref.match(/^\d+/)[0];
        return `<a href="https://hokurd.github.io/road/gen/${encodeURIComponent(num)}/">国道${escapeHtml(num)}号</a>`;
      }
      if(highway === 'motorway' || highway === 'trunk'){
        if(ref) return `${escapeHtml(ref)} (${escapeHtml(highway)})`;
      }
      if(/県道/.test(ref) || /県道/.test(name) || /^P\d+/.test(ref)){
        return escapeHtml(name || ref || highway);
      }

      if(name && ref) return `${escapeHtml(name)} (${escapeHtml(ref)})`;
      if(name) return escapeHtml(name);
      if(ref) return escapeHtml(ref);
      return escapeHtml(highway || 'その他の道路');
    }

    function distanceMeters(lat1, lon1, lat2, lon2){
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function onPosition(lat, lon){
      const map = L.map('map').setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      const meMarker = L.marker([lat, lon]).addTo(map).bindPopup("現在地").openPopup();

      const radius = 5000;

      const query = `
[out:json][timeout:25];
(
  way(around:${radius},${lat},${lon})["highway"~"motorway|trunk|primary|secondary"];
);
out geom;
`;

      fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: query
      })
      .then(res => {
        if(!res.ok) throw new Error('Overpass API error');
        return res.json();
      })
      .then(data => {
        if(!data.elements || data.elements.length === 0){
          document.getElementById('current-road').innerText = '近くの道路が見つかりませんでした。';
          document.getElementById('next-intersection').innerText = '';
          document.getElementById('nearest-trunk').innerText = '';
          document.getElementById('nearest-pref').innerText = '';
          return;
        }

        let nearestWay = null, nearestPoint = null, nearestPointIndex = -1, minDist = Infinity;
        let nearestTrunk = null, minTrunk = Infinity;
        let nearestPref = null, minPref = Infinity;

        data.elements.forEach(el => {
          if(el.type !== 'way' || !el.geometry) return;
          el.geometry.forEach((pt, idx) => {
            const d = distanceMeters(lat, lon, pt.lat, pt.lon);
            if(d < minDist){
              minDist = d;
              nearestWay = el;
              nearestPoint = pt;
              nearestPointIndex = idx;
            }
            if(el.tags && el.tags.highway === 'trunk' && d < minTrunk){
              minTrunk = d; nearestTrunk = el;
            }
            if(el.tags && ((el.tags.highway === 'primary' || el.tags.highway === 'secondary') || /県道/.test(el.tags.ref || '') || /県道/.test(el.tags.name || '')) && d < minPref){
              minPref = d; nearestPref = el;
            }
          });
        });

        if(nearestWay){
          const info = makeRoadLink(nearestWay.tags);
          document.getElementById('current-road').innerHTML = `現在走行中: ${info} （距離 ${Math.round(minDist)} m）`;

          const latlngs = nearestWay.geometry.map(g => [g.lat, g.lon]);
          L.polyline(latlngs, {color: 'red', weight: 5, opacity: 0.7}).addTo(map);
          map.fitBounds(latlngs.concat([[lat, lon]]), {maxZoom: 16, padding: [40,40]});

          const tol = 10;
          const connected = data.elements.filter(e => {
            if(e.type !== 'way' || e.id === nearestWay.id || !e.geometry) return false;
            return e.geometry.some(g => distanceMeters(g.lat, g.lon, nearestPoint.lat, nearestPoint.lon) <= tol);
          });

          const connectedLinks = connected.map(w => makeRoadLink(w.tags));
          const uniqueLinks = Array.from(new Set(connectedLinks));
          document.getElementById('next-intersection').innerHTML = uniqueLinks.length ? `次の交差点で接続する道路: ${uniqueLinks.join(', ')}` : '次の交差点で接続する道路は見つかりませんでした。';
        } else {
          document.getElementById('current-road').innerText = '現在走行中の道路を判定できませんでした。';
        }

        if(nearestTrunk){
          document.getElementById('nearest-trunk').innerHTML = `最寄り国道: ${makeRoadLink(nearestTrunk.tags)} （${Math.round(minTrunk)} m）`;
        } else {
          document.getElementById('nearest-trunk').innerText = '最寄り国道は見つかりませんでした。';
        }
        if(nearestPref){
          document.getElementById('nearest-pref').innerHTML = `最寄り県道: ${makeRoadLink(nearestPref.tags)} （${Math.round(minPref)} m）`;
        } else {
          document.getElementById('nearest-pref').innerText = '最寄り県道は見つかりませんでした。';
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('current-road').innerText = '道路データの取得に失敗しました。';
      });

      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ja`)
        .then(r=>r.json())
        .then(locdata=>{
          if(locdata && locdata.address){
            const pref = locdata.address.state || locdata.address['province'] || '';
            if(pref){
              const el = document.getElementById('current-road');
              el.innerHTML = (el.innerHTML ? el.innerHTML + '<br>' : '') + `現在地の都道府県: ${escapeHtml(pref)}`;
            }
          }
        })
        .catch(()=>{/* ignore */});
    }

    if("geolocation" in navigator){
      navigator.geolocation.getCurrentPosition(
        pos => onPosition(pos.coords.latitude, pos.coords.longitude),
        err => {
          console.error('geolocation error', err);
          document.getElementById('current-road').innerText = '現在地が取得できませんでした。ブラウザの位置情報許可を確認してください。';
        },
        {enableHighAccuracy: true, maximumAge: 10000, timeout: 10000}
      );
    }else{
      document.getElementById('current-road').innerText = 'このブラウザでは位置情報が利用できません。';
    }
  </script>
  
  <script>
    fetch('https://hokurd.github.io/assets/json/menu.json')
      .then(res => res.json())
      .then(data => {
        const menu = document.getElementById('menu');
        const ul = document.createElement('ul');
        data.forEach(item => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = item.link;
          a.textContent = item.title;
          li.appendChild(a);
          ul.appendChild(li);
        });
        menu.appendChild(ul);
      });
  </script>
</body>
</html>
