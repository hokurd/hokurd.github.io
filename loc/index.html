<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="北陸地区の道路をまとめたページです。">
  <meta name="robots" content="index, follow">

  <meta property="og:title" content="ほくりく道路図鑑">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ほくりく道路図鑑">
  <meta property="og:locale" content="ja_JP">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ほくりく道路図鑑">
  <meta name="twitter:description" content="北陸地区の道路をまとめたページです。">

  <title>ほくりく道路図鑑 | 現在地から探す</title>
  <link rel="stylesheet" href="https://hokurd.github.io/assets/css/common.css">
  <link rel="icon" href="https://hokurd.github.io/assets/img/rd/country/41.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1><a href="https://hokurd.github.io/" style="color: white;"><img src="https://hokurd.github.io/assets/img/rd/country/41.png" alt="管理団体画像" style="height:48px; width:auto;"> ほくりく道路図鑑</a></h1>
  </header>

  <div class="container">
    <aside id="menu"></aside>

    <main id="content">
      <section>
        <h2>現在地から探す</h2>
        <p>現在地から探します。</p>
      </section>
      <div class="spacer"></div>
      <section>
      <h2>現在地</h2>
        <div id="map" style="width:100%; height:400px;"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>今走行している道路</h2>
        <div id="current-road"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>次の交差点</h2>
        <div id="next-intersection"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>最も近い国道</h2>
        <div id="nearest-trunk"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>最も近い県道</h2>
        <div id="nearest-pref"></div>
      </section>
    </main>
  </div>

  <footer>
    <p>Copyright © いゆかも工房 All rights reserved.</p>
  </footer>

  <script>
    function makeRoadLink(tags) {
      if (!tags || !tags.ref) return "その他の道路";
      let ref = tags.ref;
      let highway = tags.highway || "";
  
      if ((highway === "trunk" || highway === "primary") && ref.match(/^\d+$/)) {
        return `<a href="https://hokurd.github.io/road/gen/${ref}/">国道${ref}号</a>`;
      }
      if (highway === "motorway" && ref.match(/^E\d+/i)) {
        return `<a href="https://hokurd.github.io/road/expwy/${ref.toLowerCase()}/">高速道路 ${ref}</a>`;
      }
      if ((highway === "primary" || highway === "secondary") && ref.match(/県道/)) {
        let m = ref.match(/(.+?)県道(\d+)/);
        if (m) {
          let pref = m[1].toLowerCase();
          let num = m[2];
          return `<a href="https://hokurd.github.io/road/pref/${pref}/${num}/">${ref}</a>`;
        }
      }
      return "その他の道路";
    }
  
    navigator.geolocation.getCurrentPosition(function(pos) {
      var lat = pos.coords.latitude;
      var lon = pos.coords.longitude;
  
      var map = L.map('map').setView([lat, lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      L.marker([lat, lon]).addTo(map).bindPopup("現在地").openPopup();
  
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ja`)
        .then(res => res.json())
        .then(locdata => {
          var prefecture = locdata.address.state;
          document.getElementById("current-road").innerHTML =
            "現在地の都道府県: " + prefecture;
  
          var query = `
            [out:json][timeout:25];
            area["name"="${prefecture}"]->.target;
            (
              way["highway"="motorway"](area.target);
              way["highway"="trunk"](area.target);
              way["highway"="primary"](area.target);
              way["highway"="secondary"](area.target);
            );
            out body; >; out skel qt;
          `;
  
          fetch("https://overpass-api.de/api/interpreter", {
            method: "POST", body: query
          })
          .then(res => res.json())
          .then(data => {
            var nearest = null, minDist = Infinity;
            var nearestTrunk = null, minTrunk = Infinity;
            var nearestPref = null, minPref = Infinity;
  
            function distance(lat1, lon1, lat2, lon2) {
              var R = 6371e3;
              var φ1 = lat1*Math.PI/180, φ2 = lat2*Math.PI/180;
              var Δφ = (lat2-lat1)*Math.PI/180, Δλ = (lon2-lon1)*Math.PI/180;
              var a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
              return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
  
            data.elements.forEach(el => {
              if (el.type==="way" && el.nodes) {
                var latlngs = el.nodes.map(nid => {
                  var node = data.elements.find(e => e.type==="node" && e.id===nid);
                  return [node.lat, node.lon];
                });
                latlngs.forEach(pt => {
                  var d = distance(lat, lon, pt[0], pt[1]);
                  if (d < minDist) { minDist = d; nearest = el; }
                  if (el.tags && el.tags.highway === "trunk" && d < minTrunk) {
                    minTrunk = d; nearestTrunk = el;
                  }
                  if (el.tags && (el.tags.highway === "primary" || el.tags.highway === "secondary") && d < minPref) {
                    minPref = d; nearestPref = el;
                  }
                });
              }
            });
  
            if (nearest) {
              document.getElementById("current-road").innerHTML +=
                "<br>現在走行中: " + makeRoadLink(nearest.tags);
  
              var nextNode = nearest.nodes[1];
              var connectedWays = data.elements.filter(e => e.type==="way" && e.nodes.includes(nextNode) && e.id !== nearest.id);
              var crossingLinks = connectedWays.map(w => makeRoadLink(w.tags));
              document.getElementById("next-intersection").innerHTML =
                "次の交差点で接続する道路: " + crossingLinks.join(", ");
            }
  
            if (nearestTrunk) {
              document.getElementById("nearest-trunk").innerHTML =
                "最寄り国道: " + makeRoadLink(nearestTrunk.tags);
            }
            if (nearestPref) {
              document.getElementById("nearest-pref").innerHTML =
                "最寄り県道: " + makeRoadLink(nearestPref.tags);
            }
          });
        });
    });
  </script>
  
  <script>
    fetch('https://hokurd.github.io/assets/json/menu.json')
      .then(res => res.json())
      .then(data => {
        const menu = document.getElementById('menu');
        const ul = document.createElement('ul');
        data.forEach(item => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = item.link;
          a.textContent = item.title;
          li.appendChild(a);
          ul.appendChild(li);
        });
        menu.appendChild(ul);
      });
  </script>
</body>
</html>
