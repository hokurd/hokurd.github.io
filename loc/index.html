<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="北陸地区の道路をまとめたページです。">
  <meta name="robots" content="index, follow">

  <meta property="og:title" content="ほくりく道路図鑑">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ほくりく道路図鑑">
  <meta property="og:locale" content="ja_JP">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ほくりく道路図鑑">
  <meta name="twitter:description" content="北陸地区の道路をまとめたページです。">

  <title>ほくりく道路図鑑 | 現在地から探す</title>
  <link rel="stylesheet" href="https://hokurd.github.io/assets/css/common.css">
  <link rel="icon" href="https://hokurd.github.io/assets/img/rd/country/41.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1><a href="https://hokurd.github.io/" style="color: white;"><img src="https://hokurd.github.io/assets/img/rd/country/41.png" alt="管理団体画像" style="height:48px; width:auto;"> ほくりく道路図鑑</a></h1>
  </header>

  <div class="container">
    <aside id="menu"></aside>

    <main id="content">
      <section>
        <h2>現在地から探す</h2>
        <p>現在地から探します。</p>
        <p>地図や情報の取得には時間がかかります。</p>
        <p>この機能はテスト段階です。</p>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>現在地</h2>
        <div id="map" style="width:100%; height:400px;"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>今走行している道路</h2>
        <div id="current-road"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>次の交差点</h2>
        <div id="next-intersection"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>最も近い高速道路</h2>
        <div id="nearest-motorway"></div>
        <div id="map-motorway" style="width:100%; height:200px; margin-top:8px;"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>最も近い国道</h2>
        <div id="nearest-trunk"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>最も近い県道</h2>
        <div id="nearest-pref"></div>
      </section>
    </main>
  </div>

  <footer>
    <p>Copyright © いゆかも工房 All rights reserved.</p>
  </footer>

  <script>
    function escapeHtml(s){ return String(s || '').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  
    const PREF_BG = {
      '富山県': 'toyama',
      '新潟県': 'niigata',
      '石川県': 'ishikawa',
      '福井県': 'fukui'
    };
  
    function pickRefToken(ref){
      if(!ref) return '';
      const parts = ref.split(/[\s;,\/]+/);
      for(const p of parts){
        if(/^E\d+/i.test(p)) return p;
      }
      for(const p of parts){
        if(/^\d+$/.test(p)) return p;
      }
      // 末尾フォールバック
      return parts[0] || '';
    }
  
    function isPrefectureWay(tags, currentPrefName){
      if(!tags) return false;
      const name = (tags.name || '') + ' ' + (tags.ref || '') + ' ' + (tags.network || '');
      if(/県道/.test(name)) return true;
      if(/JP:pref/i.test(tags.network || '')) return true;
      if(/^P\d+/i.test(tags.ref || '')) return true;
      if(currentPrefName){
        const shortPref = currentPrefName.replace(/県|府|都|道$/, '');
        if(new RegExp(shortPref).test(name)) return true;
      }
      return false;
    }
  
    function isMotorwayWay(tags){
      if(!tags) return false;
      if(tags.highway === 'motorway') return true;
      if(/^E\d+/i.test(tags.ref || '')) return true;
      return false;
    }
  
    function isNationalWay(tags, currentPrefName){
      if(!tags) return false;
      if(isPrefectureWay(tags, currentPrefName)) return false;
      if(tags.highway === 'trunk') return true;
      const r = pickRefToken(tags.ref || '');
      if(/^\d+$/.test(r)) return true;
      return false;
    }
  
    function shortRoadLabel(tags, currentPrefName){
      if(!tags) return '不明な道路';
      if(tags.name) return tags.name;
      const r = pickRefToken(tags.ref || '');
      if(isMotorwayWay(tags)) return (r ? r + ' ' : '') + (tags.name || '高速道路');
      if(isNationalWay(tags, currentPrefName)) return (r ? '国道' + r + '号' : '国道');
      if(isPrefectureWay(tags, currentPrefName)) return (r ? '県道' + r : '県道');
      return tags.ref || tags.highway || '道路';
    }
  
    function makeRoadAnchor(tags, currentPrefName){
      const refToken = pickRefToken(tags && tags.ref ? tags.ref : '');
      const name = tags && tags.name ? tags.name : '';
  
      if(isMotorwayWay(tags)){
        const code = refToken || (tags.operator || '').replace(/\s+/g,'') || 'E?';
        const href = `https://hokurd.github.io/road/expwy/${encodeURIComponent(code.toLowerCase())}/`;
        const inner = `<span style="display: inline-block; width: 3em; color: #ffffff; border-radius: 2px; text-align: center; padding: 5px 0; margin: 2px; background-color: #00702c;">${escapeHtml(code)}</span>${escapeHtml(name || code)}`;
        return `<a class="contact-button" href="${href}">${inner}</a>`;
      }
  
      if(isPrefectureWay(tags, currentPrefName)){
        const bg = PREF_BG[currentPrefName] || (currentPrefName ? (currentPrefName.replace(/県$/,'').toLowerCase()) : 'toyamafallback');
        const digits = String(refToken || (name.match(/(\d+)/) || [''])[0] || '');
        const digitImgs = digits.split('').map(d => `<img src="https://hokurd.github.io/assets/img/rd/pref/${escapeHtml(d || '0')}.png" alt="${escapeHtml(d)}" style="height:20px; width:auto;">`).join('');
        const prefKey = PREF_BG[currentPrefName] || (currentPrefName ? currentPrefName.replace(/県$/,'').toLowerCase() : 'unknown');
        const href = `https://hokurd.github.io/road/pref/${encodeURIComponent(prefKey)}/road/?rd=${encodeURIComponent(digits)}`;
        const inner = `<div style="position:relative; display:inline-block;"><img src="https://hokurd.github.io/assets/img/rd/pref/${bg}.png" alt="県道背景画像" style="height:48px; width:auto;"><div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -65%); display:flex; align-items:center; justify-content:center;">${digitImgs}</div></div>${escapeHtml(name || ('県道' + digits))}`;
        return `<a class="contact-button" href="${href}">${inner}</a>`;
      }
  
      if(isNationalWay(tags, currentPrefName)){
        const num = refToken || (name.match(/(\d+)/) || [''])[0] || '';
        const href = `https://hokurd.github.io/road/gen/${encodeURIComponent(num)}/`;
        const img = `<img src="https://hokurd.github.io/assets/img/rd/country/${encodeURIComponent(num)}.png" alt="国道画像" style="height:48px; width:auto;">`;
        const inner = `${img}${escapeHtml(name || ('国道' + num + '号'))}`;
        return `<a class="contact-button" href="${href}">${inner}</a>`;
      }
  
      const display = escapeHtml(name || tags.ref || tags.highway || '道路');
      return `<a class="contact-button" href="#">${display}</a>`;
    }
  
    function distanceMeters(lat1, lon1, lat2, lon2){
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
  
    function buildIntersectionLabel(connectedWays, nearestPoint, currentPrefName){
      const labels = connectedWays.map(w => shortRoadLabel(w.tags, currentPrefName)).filter(Boolean);
      const uniq = Array.from(new Set(labels));
      if(uniq.length >= 2){
        return `${uniq[0]} と ${uniq[1]} の交差点`;
      }else if(uniq.length === 1){
        return `${uniq[0]} の交差点`;
      }
      if(!nearestPoint) return '交差点';
      return fetch(`https://nominatim.openstreetmap.org/reverse?lat=${nearestPoint.lat}&lon=${nearestPoint.lon}&format=json&zoom=18&accept-language=ja`)
        .then(r => r.ok ? r.json() : null)
        .then(loc => {
          if(loc && loc.address){
            const road = loc.address.road || loc.address.pedestrian || loc.address.cycleway || loc.display_name || '';
            return road ? `${road} の交差点` : (loc.display_name || '交差点');
          }
          return '交差点';
        })
        .catch(()=> '交差点');
    }
  
    function onPosition(lat, lon){
      const map = L.map('map').setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      const meMarker = L.marker([lat, lon]).addTo(map).bindPopup("現在地").openPopup();
  
      const radius = 5000;
      const query = `
  [out:json][timeout:25];
  (
    way(around:${radius},${lat},${lon})["highway"~"motorway|trunk|primary|secondary"];
    node(around:${radius},${lat},${lon})["highway"~"traffic_signals|stop|crossing|give_way"];
  );
  out geom;
  `;
  
      fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query })
        .then(r => { if(!r.ok) throw new Error('Overpass error'); return r.json(); })
        .then(data => {
          if(!data.elements || data.elements.length === 0){
            document.getElementById('current-road').innerText = '近くの道路が見つかりませんでした。';
            return;
          }
  
          const ways = data.elements.filter(e => e.type === 'way' && e.geometry);
          const nodes = data.elements.filter(e => e.type === 'node' && e.lat && e.lon);
  
          let nearestWay = null, nearestPoint = null, nearestPointIndex = -1, minDist = Infinity;
          ways.forEach(el => {
            el.geometry.forEach((pt, idx) => {
              const d = distanceMeters(lat, lon, pt.lat, pt.lon);
              if(d < minDist){
                minDist = d;
                nearestWay = el;
                nearestPoint = pt;
                nearestPointIndex = idx;
              }
            });
          });
  
          fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ja`)
            .then(r=>r.json())
            .then(locdata=>{
              const pref = (locdata && locdata.address) ? (locdata.address.state || locdata.address.province || '') : '';
  
              if(!nearestWay){
                document.getElementById('current-road').innerText = '現在走行中の道路を判定できませんでした。';
                return;
              }
  
              let nearestTrunk = null, minTrunk = Infinity;
              let nearestPref = null, minPref = Infinity;
              let nearestMotorway = null, minMotorway = Infinity;
  
              ways.forEach(el => {
                el.geometry.forEach(pt => {
                  const d = distanceMeters(lat, lon, pt.lat, pt.lon);
                  if(isMotorwayWay(el.tags) && d < minMotorway){
                    minMotorway = d; nearestMotorway = el;
                  }
                  if(isPrefectureWay(el.tags, pref) && d < minPref){
                    minPref = d; nearestPref = el;
                  }
                  if(isNationalWay(el.tags, pref) && d < minTrunk){
                    minTrunk = d; nearestTrunk = el;
                  }
                });
              });
  
              document.getElementById('current-road').innerHTML = `現在走行中: ${makeRoadAnchor(nearestWay.tags || {}, pref)} （${Math.round(minDist)} m）`;
              const latlngs = nearestWay.geometry.map(g => [g.lat, g.lon]);
              L.polyline(latlngs, {color: 'red', weight: 6, opacity: 0.9}).addTo(map);
              map.fitBounds(latlngs.concat([[lat, lon]]), {maxZoom: 16, padding: [40,40]});
  
              const tol = 15;
              const connected = ways.filter(e => {
                if(e.id === nearestWay.id) return false;
                return e.geometry.some(g => distanceMeters(g.lat, g.lon, nearestPoint.lat, nearestPoint.lon) <= tol);
              });
  
              const maybeLabel = buildIntersectionLabel(connected, nearestPoint, pref);
              if(typeof maybeLabel === 'string'){
                document.getElementById('next-intersection').innerHTML = `次の交差点: ${escapeHtml(maybeLabel)}`;
              }else{
                maybeLabel.then(lbl => {
                  document.getElementById('next-intersection').innerHTML = `次の交差点: ${escapeHtml(lbl)}`;
                });
              }
  
              if(nearestMotorway){
                const mLatlngs = nearestMotorway.geometry.map(g => [g.lat, g.lon]);
                L.polyline(mLatlngs, {color: 'orange', weight: 5, dashArray: '6 4', opacity: 0.8}).addTo(map);
              }
  
              if(nearestTrunk){
                const trunkAnchor = makeRoadAnchor(nearestTrunk.tags || {}, pref);
                let motorwayLine = '';
                if(nearestMotorway){
                  motorwayLine = `<div style="margin-bottom:4px;">最も近い高速道路: ${makeRoadAnchor(nearestMotorway.tags || {}, pref)}</div>`;
                }
                document.getElementById('nearest-trunk').innerHTML = `${motorwayLine}最寄り国道: ${trunkAnchor} （${Math.round(minTrunk)} m）`;
                const tLatlngs = nearestTrunk.geometry.map(g => [g.lat, g.lon]);
                L.polyline(tLatlngs, {color: 'blue', weight: 5, opacity: 0.7}).addTo(map);
              } else {
                document.getElementById('nearest-trunk').innerText = '最寄り国道は見つかりませんでした。';
              }
  
              if(nearestPref){
                const prefAnchor = makeRoadAnchor(nearestPref.tags || {}, pref);
                document.getElementById('nearest-pref').innerHTML = `最寄り県道: ${prefAnchor} （${Math.round(minPref)} m）`;
                const pLatlngs = nearestPref.geometry.map(g => [g.lat, g.lon]);
                L.polyline(pLatlngs, {color: 'green', weight: 5, opacity: 0.7}).addTo(map);
              } else {
                document.getElementById('nearest-pref').innerText = '最寄り県道は見つかりませんでした。';
              }
  
            })
            .catch(()=>{
              const pref = '';
              if(!nearestWay){
                document.getElementById('current-road').innerText = '現在走行中の道路を判定できませんでした。';
                return;
              }
              document.getElementById('current-road').innerHTML = `現在走行中: ${makeRoadAnchor(nearestWay.tags || {}, pref)} （${Math.round(minDist)} m）`;
            });
        })
        .catch(err => {
          console.error(err);
          document.getElementById('current-road').innerText = '道路データの取得に失敗しました。';
        });
    }
  
    if("geolocation" in navigator){
      navigator.geolocation.getCurrentPosition(
        pos => onPosition(pos.coords.latitude, pos.coords.longitude),
        err => {
          console.error('geolocation error', err);
          document.getElementById('current-road').innerText = '現在地が取得できませんでした。ブラウザの位置情報許可を確認してください。';
        },
        {enableHighAccuracy: true, maximumAge: 10000, timeout: 10000}
      );
    }else{
      document.getElementById('current-road').innerText = 'このブラウザでは位置情報が利用できません。';
    }
  </script>
  
  <script>
    fetch('https://hokurd.github.io/assets/json/menu.json')
      .then(res => res.json())
      .then(data => {
        const menu = document.getElementById('menu');
        const ul = document.createElement('ul');
        data.forEach(item => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = item.link;
          a.textContent = item.title;
          li.appendChild(a);
          ul.appendChild(li);
        });
        menu.appendChild(ul);
      });
  </script>
</body>
</html>
